картинки норм грузятся, а видео и аудио что-то не очень грузит

PayloadTooLargeError: request entity too large
    at readStream (D:\cod\Fullstack-MVP-testing\node_modules\raw-body\index.js:163:17)
    at getRawBody (D:\cod\Fullstack-MVP-testing\node_modules\raw-body\index.js:116:12)
    at read (D:\cod\Fullstack-MVP-testing\node_modules\body-parser\lib\read.js:79:3)
    at jsonParser (D:\cod\Fullstack-MVP-testing\node_modules\body-parser\lib\types\json.js:138:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at expressInit (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\middleware\init.js:40:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at query (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\middleware\query.js:45:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at router.handle (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:175:3)
    at app.handle (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\application.js:181:10)
    at Server.app (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\express.js:39:9)
    at Server.emit (node:events:508:28)
    at parserOnIncoming (node:_http_server:1210:12)
    at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)
PayloadTooLargeError: request entity too large
    at readStream (D:\cod\Fullstack-MVP-testing\node_modules\raw-body\index.js:163:17)
    at getRawBody (D:\cod\Fullstack-MVP-testing\node_modules\raw-body\index.js:116:12)
    at read (D:\cod\Fullstack-MVP-testing\node_modules\body-parser\lib\read.js:79:3)
    at jsonParser (D:\cod\Fullstack-MVP-testing\node_modules\body-parser\lib\types\json.js:138:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at expressInit (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\middleware\init.js:40:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at query (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\middleware\query.js:45:5)
    at Layer.handle [as handle_request] (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\layer.js:95:5)
    at trim_prefix (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:328:13)
    at D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:286:9
    at router.process_params (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:346:12)
    at next (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:280:10)
    at router.handle (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\router\index.js:175:3)
    at app.handle (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\application.js:181:10)
    at Server.app (D:\cod\Fullstack-MVP-testing\node_modules\express\lib\express.js:39:9)
    at Server.emit (node:events:508:28)
    at parserOnIncoming (node:_http_server:1210:12)
    at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)
Думал на протяжении 6m 27s

Ок, делаем правильно: видео/аудио нельзя пихать base64 в JSON — оно упирается в PayloadTooLargeError (лимит express.json() по умолчанию маленький). Решение: загрузка файла через multipart/form-data (multer) + сохраняем URL в mediaUrl.

Ниже — точные места (строки) что куда вставлять по твоим файлам /mnt/data/routes.ts и /mnt/data/questions.tsx.

1) BACKEND — server/routes.ts
1.1. Импорты (строка 1 + добавить 3 импорта)

Файл: server/routes.ts

[СТРОКА 1] замени:

import type { Express, Request, Response, NextFunction } from "express";


на:

import express, { type Express, Request, Response, NextFunction } from "express";


[ПОСЛЕ СТРОКИ 6] добавь:

import path from "node:path";
import fs from "node:fs";
import crypto from "node:crypto";

1.2. Конфиг multer для медиа (вставить после const upload = multer(...))

У тебя сейчас есть:

const upload = multer({ storage: multer.memoryStorage() });


[СРАЗУ ПОСЛЕ ЭТОЙ СТРОКИ (после строки 11)] вставь:

const mediaDir = path.resolve(process.cwd(), "uploads", "media");
fs.mkdirSync(mediaDir, { recursive: true });

const mediaUpload = multer({
  storage: multer.diskStorage({
    destination: (_req, _file, cb) => cb(null, mediaDir),
    filename: (_req, file, cb) => {
      const ext = path.extname(file.originalname || "").toLowerCase();
      cb(null, `${Date.now()}_${crypto.randomUUID()}${ext}`);
    },
  }),
  limits: { fileSize: 200 * 1024 * 1024 }, // 200MB на dev, подстрой
  fileFilter: (_req, file, cb) => {
    const ok =
      file.mimetype.startsWith("image/") ||
      file.mimetype.startsWith("audio/") ||
      file.mimetype.startsWith("video/");
    cb(ok ? null : new Error("Unsupported media type"), ok);
  },
});

1.3. Раздача загруженных файлов (static)

Файл: server/routes.ts

Найди начало export function registerRoutes... (у тебя примерно строка 57).

Внутри, после app.use(session(...)) (у тебя это примерно строка 68–74), сразу после блока app.use(session(...)) вставь:

app.use("/uploads", express.static(path.resolve(process.cwd(), "uploads")));

1.4. Роут загрузки /api/media/upload

Файл: server/routes.ts

Найди место после auth-роутов:

у тебя есть:

app.post("/api/auth/register"...

app.post("/api/auth/login"...

app.post("/api/auth/logout"...

[СРАЗУ ПОСЛЕ app.post("/api/auth/logout"... (примерно после строки 112)] вставь:

app.post("/api/media/upload", mediaUpload.single("file"), (req: Request, res: Response) => {
  if (!req.file) return res.status(400).json({ error: "No file uploaded" });

  const url = `/uploads/media/${req.file.filename}`;
  res.json({
    url,
    mime: req.file.mimetype,
    originalName: req.file.originalname,
    size: req.file.size,
  });
});


✅ После этого в dev загруженные файлы будут доступны по URL типа:
/uploads/media/<filename>

2) FRONTEND — client/questions.tsx
2.1. Добавь стейт и ref

Файл: questions.tsx

У тебя блок стейтов начинается примерно тут (строки 60–85).
Найди:

const [mediaUrl, setMediaUrl] = useState<string>("");
const [mediaType, setMediaType] = useState<"image" | "audio" | "video" | "">("");


[СРАЗУ ПОСЛЕ НИХ] (после строки 68 в твоём файле из /mnt/data) вставь:

const [mediaUploading, setMediaUploading] = useState(false);
const mediaFileInputRef = useRef<HTMLInputElement>(null);

2.2. Добавь функцию загрузки файла

Найди const handleImport = () => { ... } (в твоём файле это примерно строка 198).

[СРАЗУ ПОСЛЕ handleImport (после строки ~202)] вставь:

const uploadMediaFile = async (file: File) => {
  setMediaUploading(true);
  try {
    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/api/media/upload", {
      method: "POST",
      body: fd,
      credentials: "include",
    });

    if (!res.ok) throw new Error("Upload failed");

    const out = await res.json();

    // сохраняем URL (а не base64)
    setMediaUrl(out.url);

    // определяем тип
    if (file.type.startsWith("image/")) setMediaType("image");
    else if (file.type.startsWith("audio/")) setMediaType("audio");
    else if (file.type.startsWith("video/")) setMediaType("video");

    toast({ title: "Медиа загружено", description: file.name });
  } catch (e) {
    toast({ variant: "destructive", title: t.common.error, description: "Не удалось загрузить медиа" });
  } finally {
    setMediaUploading(false);
  }
};

2.3. Вставь кнопку + hidden input в UI (в блоке Media)

Найди твой кусок (в твоём файле это строки 648–660):

<Input
  type="url"
  placeholder={t.questions.mediaUrlPlaceholder}
  value={mediaUrl}
  onChange={(e) => setMediaUrl(e.target.value)}
  data-testid="input-question-media-url"
/>


[СРАЗУ ПОСЛЕ ЭТОГО <Input .../> (после строки 659)] вставь:

<input
  ref={mediaFileInputRef}
  type="file"
  accept="image/*,audio/*,video/*"
  className="hidden"
  onChange={(e) => {
    const f = e.target.files?.[0];
    if (f) uploadMediaFile(f);
    e.currentTarget.value = ""; // чтобы повторная загрузка того же файла срабатывала
  }}
  data-testid="input-question-media-file"
/>

<Button
  type="button"
  variant="outline"
  onClick={() => mediaFileInputRef.current?.click()}
  disabled={mediaUploading}
  data-testid="button-upload-question-media"
>
  {mediaUploading ? <LoadingSpinner className="mr-2" /> : <Upload className="h-4 w-4 mr-2" />}
  Загрузить файл
</Button>

<p className="text-xs text-muted-foreground">
  Для видео/аудио используй загрузку файлом — base64 в JSON ломается по лимиту.
</p>

3) ВАЖНО: почему у тебя было PayloadTooLargeError

Потому что ты, скорее всего, кладёшь видео/аудио как base64 в mediaUrl и отправляешь через JSON при сохранении вопроса.
Теперь мы отправляем файл через FormData, а в вопрос сохраняется короткий URL → ошибки не будет.

4) Следующий шаг (чтобы SCORM тоже подхватывал эти файлы)

Сейчас в вопросе будет mediaUrl = "/uploads/media/xxx.mp4".
Чтобы SCORM-экспорт клал это внутрь ZIP, надо в экспортере:

если mediaUrl начинается с /uploads/ → прочитать файл с диска и положить его в assets/media/...

заменить ссылку в тесте на assets/media/...

Скажи — и я дам такой же пошаговый патч с номерами строк для server/scorm/... под твою текущую реализацию.

Если хочешь — скинь свой server/index.ts (или где у тебя express.json(...)), и я тоже дам точные строки, где увеличить лимит (на случай, если где-то ещё остались большие JSON).